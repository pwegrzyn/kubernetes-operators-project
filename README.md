# H2 K8s Operator

A simple Kubernetes operator for the H2 Database.


## Development

After making changes to the APIs we need to recreate the CRDs:
```console
$ operator-sdk generate k8s
$ operator-sdk generate crds
```

To install the custom CRDS in the cluster:
```console
$ kubectl apply -f deploy/crds/h2.example.com_h2databases_crd.yaml
```

To run a development instance of the operator outside the k8s cluster:
```console
$ operator-sdk run --local --watch-namespace=default
```

To deploy the operator, you need to create a container image that can be accessed by the k8s cluster:
```console
$ operator-sdk build pwegrzyndocking/kubernetes-operators-project
$ docker push pwegrzyndocking/kubernetes-operators-project
```

Now, we need to change the deployment config that was previously generated by the Operator SDK in deploy/operator.yaml:
```console
$ sed -i 's|REPLACE_IMAGE|pwegrzyndocking/kubernetes-operators-project|g' deploy/operator.yaml
```

You can deploy the Operator now using kubectl (instead of running locally outside the cluster):
```console
$ kubectl create -f deploy/service_account.yaml
$ kubectl create -f deploy/role.yaml
$ kubectl create -f deploy/role_binding.yaml
$ kubectl create -f deploy/operator.yaml
```

Now that the operator is running (either locally or in the cluster) you can create H2 CRs:
```console
$ kubectl apply -f deploy/crds/h2.example.com_v1alpha1_h2database_cr.yaml
```

To cleanup the k8s enviroment use:
```console
$ kubectl delete -f deploy/crds/h2.example.com_v1alpha1_h2database_cr.yaml
$ kubectl delete -f deploy/operator.yaml  # or ctr-C the local operator
$ kubectl delete -f deploy/role_binding.yaml
$ kubectl delete -f deploy/role.yaml
$ kubectl delete -f deploy/service_account.yaml
$ kubectl delete -f deploy/crds/h2.example.com_h2databases_crd.yaml  # remove the CRD
```


## Environment
This project has been developed using:
- go (1.14.2 linux/amd64)
- operator-sdk (0.17.0)
- minikube (1.9.2)


## Common Issues
When you get ```Deepcopy generation fails due to "unsupported type invalid type for invalid type"```
it usually means that you need to export the GO environment vars (GOROOT and GOPATH).



*This is a project for the class SUU at AGH-UST (2020).*